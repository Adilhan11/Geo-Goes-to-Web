<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Interactive map application for managing geographical points">
        <title>GeoPoint Manager</title>
        <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    </head>
    <body>
        <header>
            <h1><i class="fas fa-map-marker-alt"></i> GeoPoint Manager</h1>
        </header>
        
        <main id="container">
            <aside class="control-panel">
                <div class="action-buttons top-actions">
                    <button id="load-points-btn" class="btn-accent">
                        <i class="fas fa-sync-alt"></i> Load Points
                    </button>
                    <button id="export-geojson-btn" class="btn-info">
                        <i class="fas fa-file-export"></i> Export GeoJSON
                    </button>
                </div>

                <section class="panel-section filter-group">
                    <h3><i class="fas fa-filter"></i> Filter Points</h3>
                    <div class="button-group">
                        <button id="filter-domestic" class="btn-primary">
                            <i class="fas fa-home"></i> Domestic
                        </button>
                        <button id="filter-abroad" class="btn-secondary">
                            <i class="fas fa-globe"></i> Abroad
                        </button>
                    </div>
                </section>

                <section class="panel-section add-group">
                    <h3><i class="fas fa-plus-circle"></i> Add Point</h3>
                    <form id="add-point-form" class="form-group">
                        <div class="form-field">
                            <label for="description">
                                <i class="fas fa-pen"></i> Description:
                            </label>
                            <input type="text" id="description" name="description" 
                                   required placeholder="Enter point description">
                        </div>
                        
                        <div class="form-field">
                            <label for="image">
                                <i class="fas fa-image"></i> Image:
                            </label>
                            <input type="file" id="image" name="image" 
                                   accept="image/*">
                        </div>
                        
                        <button type="submit" class="btn-success">
                            <i class="fas fa-plus"></i> Add Point
                        </button>
                    </form>
                </section>

                <section class="panel-section drawing-group">
                    <h3><i class="fas fa-draw-polygon"></i> Drawing Tools</h3>
                    <div class="button-group">
                        <button id="draw-line" class="btn-primary">
                            <i class="fas fa-line"></i> Draw Line
                        </button>
                        <button id="draw-polygon" class="btn-secondary">
                            <i class="fas fa-draw-polygon"></i> Draw Polygon
                        </button>
                        <button id="cancel-drawing" class="btn-danger" style="display: none;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    <!-- Yeni butonlar için ayrı bir grup -->
                    <div class="button-group loading-buttons">
                        <button id="load-lines-btn" class="btn-info">
                            <i class="fas fa-route"></i> Load Lines
                        </button>
                        <button id="load-polygons-btn" class="btn-info">
                            <i class="fas fa-draw-polygon"></i> Load Polygons
                        </button>
                    </div>
                </section>
            </aside>

            <section id="map" aria-label="Interactive Map"></section>

            <div id="drawing-form" class="drawing-form" style="display: none;">
                <h3>Save Drawing</h3>
                <form id="save-drawing-form">
                    <input type="hidden" id="drawing-type">
                    <div class="form-field">
                        <label for="drawing-name">Name:</label>
                        <input type="text" id="drawing-name" required>
                    </div>
                    <div class="form-field">
                        <label for="drawing-color">Color:</label>
                        <input type="color" id="drawing-color" value="#3388ff">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn-success">Save</button>
                        <button type="button" class="btn-danger" onclick="cancelDrawing()">Cancel</button>
                    </div>
                </form>
            </div>

            <aside id="update-form-container">
                <div class="update-form-header">
                    <h3><i class="fas fa-edit"></i> Update Point</h3>
                    <button type="button" class="close-button" onclick="closeUpdateForm()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="update-point-form" class="form-group">
                    <input type="hidden" id="update-point-id">
                    
                    <div class="form-field">
                        <label for="update-description">
                            <i class="fas fa-pen"></i> Description:
                        </label>
                        <input type="text" id="update-description" name="description" 
                               required placeholder="Update point description">
                    </div>
                    
                    <div class="form-field">
                        <label for="update-image">
                            <i class="fas fa-image"></i> Update Image:
                        </label>
                        <input type="file" id="update-image" name="image" 
                               accept="image/*">
                        <div id="current-image-preview"></div>
                    </div>
                    
                    <div class="form-field">
                        <label for="update-latitude">
                            <i class="fas fa-map-marker-alt"></i> Latitude:
                        </label>
                        <input type="text" id="update-latitude" name="latitude" 
                               required pattern="^-?[0-9]*\.?[0-9]+$">
                    </div>
                    
                    <div class="form-field">
                        <label for="update-longitude">
                            <i class="fas fa-longitude"></i> Longitude:
                        </label>
                        <input type="text" id="update-longitude" name="longitude" 
                               required pattern="^-?[0-9]*\.?[0-9]+$">
                    </div>
                    
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Update Point
                    </button>
                </form>
            </aside>
        </main>

        <div id="toast" class="toast" role="alert" aria-live="polite"></div>
        <div id="image-modal" class="image-modal" onclick="closeModalOnBackground(event)">
            <div class="modal-content" onclick="stopPropagation(event)">
                <button class="close-button" onclick="closeImageModal()">
                    <i class="fas fa-times"></i>
                </button>
                <img id="modal-image" src="" alt="Full size image">
                <div class="modal-controls">
                    <button onclick="closeImageModal()" class="btn-secondary">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Toast notification system
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast toast-${type} show`;
                setTimeout(() => {
                    toast.className = toast.className.replace('show', '');
                }, 3000);
            }

            // Map layers with fixed terrain layer
            const mapLayers = {
                streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }),
                terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 17,
                    attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap'
                })
            };

            // Initialize map with streets layer and layer control
            const map = L.map('map', {
                layers: [mapLayers.streets]
            }).setView([39.9334, 32.8597], 6);

            // Add layer control to map
            L.control.layers({
                "Streets": mapLayers.streets,
                "Satellite": mapLayers.satellite,
                "Terrain": mapLayers.terrain
            }, null, {
                position: 'topright'
            }).addTo(map);

            let selectedMarker = null;
            let selectedLatLng = null;

            // Map click handler
            map.on('click', function(e) {
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                }

                selectedMarker = L.marker([e.latlng.lat, e.latlng.lng], { 
                    draggable: true,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<i class="fas fa-map-marker-alt"></i>'
                    })
                }).addTo(map);

                const popupContent = document.createElement('div');
                popupContent.className = 'marker-popup';
                popupContent.innerHTML = `
                    <h4>Selected Point</h4>
                    <p>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}</p>
                    <button onclick="removeMarker()" class="btn-danger">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;

                selectedMarker.bindPopup(popupContent).openPopup();

                selectedMarker.on('dragend', function(event) {
                    const position = event.target.getLatLng();
                    console.log('New Position:', position);
                    selectedLatLng = position;
                    showToast('Marker position updated', 'info');
                });

                selectedLatLng = e.latlng;
                showToast('New marker placed', 'success');
            });

            function removeMarker() {
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                    selectedMarker = null;
                    selectedLatLng = null;
                    showToast('Marker removed', 'warning');
                }
            }

            // Load points
            document.getElementById('load-points-btn').addEventListener('click', function() {
                const token = localStorage.getItem('token');
                this.classList.add('loading');
                
                fetch('http://localhost:3000/api/points', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error('Invalid data format');
                    }
                    
                    data.forEach(point => {
                        const marker = L.marker([point.latitude, point.longitude], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<i class="fas fa-map-marker-alt"></i>'
                            })
                        }).addTo(map);

                        const popupContent = document.createElement('div');
                        popupContent.className = 'marker-popup';
                        popupContent.innerHTML = `
                            <h4>${point.description}</h4>
                            <p>Lat: ${point.latitude}<br>Lng: ${point.longitude}</p>
                            ${point.image_url ? 
                                `<img src="http://localhost:3000/${point.image_url}" 
                                      alt="${point.description}" 
                                      class="popup-image">` : 
                                ''}
                            <div class="popup-actions">
                                <button onclick="editPoint(${point.id}, '${point.description}', 
                                        ${point.latitude}, ${point.longitude})" 
                                        class="btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deletePoint(${point.id})" 
                                        class="btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                    });
                    showToast('Points loaded successfully', 'success');
                })
                .catch(err => {
                    console.error('Error loading points:', err);
                    showToast('Error loading points', 'error');
                });
            });

            // Filter functions
            function isWithinTurkey(lat, lng) {
                const minLat = 35.0, maxLat = 42.0;
                const minLng = 25.0, maxLng = 45.0;
                return lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng;
            }

            function clearMarkers() {
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
            }

            // Filter handlers
            ['domestic', 'abroad'].forEach(type => {
                document.getElementById(`filter-${type}`).addEventListener('click', function() {
                    const token = localStorage.getItem('token');
                    fetch('http://localhost:3000/api/points', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data)) throw new Error('Invalid data format');
                        clearMarkers();
                        data.forEach(point => {
                            const isDomestic = isWithinTurkey(point.latitude, point.longitude);
                            if ((type === 'domestic' && isDomestic) || 
                                (type === 'abroad' && !isDomestic)) {
                                const marker = L.marker([point.latitude, point.longitude], {
                                    icon: L.divIcon({
                                        className: 'custom-marker',
                                        html: '<i class="fas fa-map-marker-alt"></i>'
                                    })
                                }).addTo(map);
                                marker.bindPopup(`<b>${point.description}</b>`);
                            }
                        });
                        showToast(`Filtered ${type} points`, 'info');
                    })
                    .catch(err => {
                        console.error(`Error filtering ${type} points:`, err);
                        showToast(`Error filtering ${type} points`, 'error');
                    });
                });
            });

            function editPoint(id, description, latitude, longitude) {
                document.getElementById('update-point-id').value = id;
                document.getElementById('update-description').value = description;
                document.getElementById('update-latitude').value = latitude;
                document.getElementById('update-longitude').value = longitude;
                document.getElementById('update-form-container').style.display = 'block';
                showToast('Edit mode activated', 'info');
            }

            // Update form handler
            document.getElementById('update-point-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('update-point-id').value;
                const description = document.getElementById('update-description').value;
                const latitude = document.getElementById('update-latitude').value;
                const longitude = document.getElementById('update-longitude').value;

                fetch(`http://localhost:3000/api/points/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ description, latitude, longitude })
                })
                .then(response => response.json())
                .then(() => {
                    document.getElementById('update-form-container').style.display = 'none';
                    showToast('Point updated successfully', 'success');
                    location.reload();
                })
                .catch(err => {
                    console.error('Error updating point:', err);
                    showToast('Error updating point', 'error');
                });
            });

            // Add point form handler
            document.getElementById('add-point-form').addEventListener('submit', function(e) {
                e.preventDefault();
                if (!selectedLatLng) {
                    showToast('Please select a location on the map first', 'warning');
                    return;
                }

                const description = document.getElementById('description').value;
                const imageFile = document.getElementById('image').files[0];
                const formData = new FormData();
                
                formData.append('description', description);
                formData.append('latitude', selectedLatLng.lat);
                formData.append('longitude', selectedLatLng.lng);
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const token = localStorage.getItem('token');
                fetch('http://localhost:3000/api/points', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error adding point');
                    return response.json();
                })
                .then(() => {
                    showToast('Point added successfully', 'success');
                    this.reset();
                    if (selectedMarker) {
                        map.removeLayer(selectedMarker);
                        selectedMarker = null;
                        selectedLatLng = null;
                    }
                    document.getElementById('load-points-btn').click();
                })
                .catch(err => {
                    console.error('Error adding point:', err);
                    showToast('Error adding point', 'error');
                });
            });

            // Export GeoJSON handler
            document.getElementById('export-geojson-btn').addEventListener('click', function() {
                const token = localStorage.getItem('token');
                this.classList.add('loading');
                
                fetch('http://localhost:3000/api/points', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error fetching points');
                    return response.json();
                })
                .then(points => {
                    const geojson = {
                        type: 'FeatureCollection',
                        features: points.map(point => ({
                            type: 'Feature',
                            properties: {
                                id: point.id,
                                description: point.description,
                                image_url: point.image_url
                            },
                            geometry: {
                                type: 'Point',
                                coordinates: [point.longitude, point.latitude]
                            }
                        }))
                    };

                    // Create and trigger download
                    const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'points.geojson';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast('GeoJSON exported successfully', 'success');
                })
                .catch(err => {
                    console.error('Error exporting GeoJSON:', err);
                    showToast('Error exporting GeoJSON', 'error');
                })
                .finally(() => {
                    this.classList.remove('loading');
                });
            });

            // Delete point function
            function deletePoint(id) {
                if (confirm('Are you sure you want to delete this point?')) {
                    const token = localStorage.getItem('token');
                    fetch(`http://localhost:3000/api/points/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Error deleting point');
                        return response.json();
                    })
                    .then(() => {
                        showToast('Point deleted successfully', 'success');
                        clearMarkers();
                        document.getElementById('load-points-btn').click();
                    })
                    .catch(err => {
                        console.error('Error deleting point:', err);
                        showToast('Error deleting point', 'error');
                    });
                }
            }

            // Update marker style
            function createCustomMarker(latlng, options = {}) {
                return L.marker(latlng, {
                    ...options,
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<i class="fas fa-map-marker-alt"></i>',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    })
                });
            }

            // Map click handler with improved marker
            map.on('click', function(e) {
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                }

                selectedMarker = createCustomMarker([e.latlng.lat, e.latlng.lng], { 
                    draggable: true 
                }).addTo(map);

                const popupContent = document.createElement('div');
                popupContent.className = 'marker-popup';
                popupContent.innerHTML = `
                    <h4>Selected Point</h4>
                    <p>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}</p>
                    <button onclick="removeMarker()" class="btn-danger">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;

                selectedMarker.bindPopup(popupContent).openPopup();

                selectedMarker.on('dragend', function(event) {
                    const position = event.target.getLatLng();
                    selectedLatLng = position;
                    
                    // Update popup content with new coordinates
                    const newPopupContent = document.createElement('div');
                    newPopupContent.className = 'marker-popup';
                    newPopupContent.innerHTML = `
                        <h4>Selected Point</h4>
                        <p>Lat: ${position.lat.toFixed(6)}<br>Lng: ${position.lng.toFixed(6)}</p>
                        <button onclick="removeMarker()" class="btn-danger">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    `;
                    selectedMarker.setPopupContent(newPopupContent);
                    showToast('Marker position updated', 'info');
                });

                selectedLatLng = e.latlng;
                showToast('New marker placed', 'success');
            });

            // Load points with improved markers
            document.getElementById('load-points-btn').addEventListener('click', function() {
                const token = localStorage.getItem('token');
                this.classList.add('loading');
                
                fetch('http://localhost:3000/api/points', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) throw new Error('Invalid data format');
                    clearMarkers();
                    
                    data.forEach(point => {
                        const marker = createCustomMarker([point.latitude, point.longitude]).addTo(map);

                        const popupContent = document.createElement('div');
                        popupContent.className = 'marker-popup';
                        popupContent.innerHTML = `
                            <h4>${point.description}</h4>
                            <p>Lat: ${point.latitude}<br>Lng: ${point.longitude}</p>
                            ${point.image_url ? 
                                `<img src="http://localhost:3000/${point.image_url}" 
                                      alt="${point.description}" 
                                      class="popup-image">` : 
                                ''}
                            <div class="popup-actions">
                                <button onclick="editPoint(${point.id}, '${point.description}', 
                                        ${point.latitude}, ${point.longitude}, '${point.image_url || ''}')" 
                                        class="btn-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deletePoint(${point.id})" 
                                        class="btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                    });
                    showToast('Points loaded successfully', 'success');
                })
                .catch(err => {
                    console.error('Error loading points:', err);
                    showToast('Error loading points', 'error');
                })
                .finally(() => {
                    this.classList.remove('loading');
                });
            });

            // Enhanced edit point function with image support
            function editPoint(id, description, latitude, longitude, imageUrl) {
                document.getElementById('update-point-id').value = id;
                document.getElementById('update-description').value = description;
                document.getElementById('update-latitude').value = latitude;
                document.getElementById('update-longitude').value = longitude;
                
                // Show current image if exists
                const imagePreview = document.getElementById('current-image-preview');
                if (imageUrl) {
                    const fullImageUrl = `http://localhost:3000/${imageUrl}`;
                    imagePreview.innerHTML = `
                        <img src="${fullImageUrl}" 
                             alt="Current image" 
                             class="preview-image"
                             onclick="openImageModal('${fullImageUrl}')">
                    `;
                } else {
                    imagePreview.innerHTML = '<p>No current image</p>';
                }

                // Create draggable marker for editing
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                }

                selectedMarker = createCustomMarker([latitude, longitude], { 
                    draggable: true 
                }).addTo(map);

                selectedMarker.on('dragend', function(event) {
                    const position = event.target.getLatLng();
                    document.getElementById('update-latitude').value = position.lat.toFixed(6);
                    document.getElementById('update-longitude').value = position.lng.toFixed(6);
                    showToast('Marker position updated', 'info');
                });

                map.setView([latitude, longitude], 13);
                document.getElementById('update-form-container').style.display = 'block';
                showToast('Edit mode activated', 'info');
            }

            // Enhanced update form handler with image support
            document.getElementById('update-point-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData();
                const id = document.getElementById('update-point-id').value;
                
                formData.append('description', document.getElementById('update-description').value);
                formData.append('latitude', document.getElementById('update-latitude').value);
                formData.append('longitude', document.getElementById('update-longitude').value);
                
                const imageFile = document.getElementById('update-image').files[0];
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                try {
                    const response = await fetch(`http://localhost:3000/api/points/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }

                    showToast('Point updated successfully', 'success');
                    document.getElementById('update-form-container').style.display = 'none';
                    
                    // Refresh points on the map
                    clearMarkers();
                    document.getElementById('load-points-btn').click();
                } catch (err) {
                    console.error('Error updating point:', err);
                    showToast('Error updating point: ' + err.message, 'error');
                }
            });

            // Image modal functions
            function openImageModal(imageUrl) {
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('modal-image');
                modalImg.src = imageUrl.replace(/\\/g, '/');
                modal.classList.add('show');
                modalImg.dataset.originalUrl = imageUrl;
                
                // ESC tuşu ile kapatma özelliği ekle
                document.addEventListener('keydown', handleEscKey);
            }

            function closeModalOnBackground(event) {
                if (event.target.className === 'image-modal') {
                    closeImageModal();
                }
            }

            function stopPropagation(event) {
                event.stopPropagation();
            }

            function closeImageModal() {
                const modal = document.getElementById('image-modal');
                modal.classList.remove('show');
            }

            function handleEscKey(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                    // Event listener'ı temizle
                    document.removeEventListener('keydown', handleEscKey);
                }
            }

            // Close modal when clicking outside the image
            document.getElementById('image-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImageModal();
                }
            });

            // Update the marker popup content generation
            function createMarkerPopup(point) {
                const popupContent = document.createElement('div');
                popupContent.className = 'marker-popup';
                
                let imageHtml = '';
                if (point.image_url) {
                    const fullImageUrl = `http://localhost:3000/${point.image_url.replace(/\\/g, '/')}`;
                    imageHtml = `
                        <img src="${fullImageUrl}" 
                             alt="${point.description}" 
                             class="popup-image"
                             onclick="openImageModal('${fullImageUrl}')"
                             style="cursor: pointer;">
                    `;
                }
                
                popupContent.innerHTML = `
                    <h4>${point.description}</h4>
                    <p>Lat: ${point.latitude}<br>Lng: ${point.longitude}</p>
                    ${imageHtml}
                    <div class="popup-actions">
                        <button onclick="editPoint(${point.id}, '${point.description}', 
                                ${point.latitude}, ${point.longitude}, '${point.image_url || ''}')" 
                                class="btn-primary">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deletePoint(${point.id})" 
                                class="btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                return popupContent;
            }

            // Update the load points handler to use the new popup creation
            document.getElementById('load-points-btn').addEventListener('click', function() {
                const token = localStorage.getItem('token');
                this.classList.add('loading');
                
                fetch('http://localhost:3000/api/points', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) throw new Error('Invalid data format');
                    clearMarkers();
                    
                    data.forEach(point => {
                        const marker = createCustomMarker([point.latitude, point.longitude]).addTo(map);
                        marker.bindPopup(createMarkerPopup(point));
                    });
                    showToast('Points loaded successfully', 'success');
                })
                .catch(err => {
                    console.error('Error loading points:', err);
                    showToast('Error loading points', 'error');
                })
                .finally(() => {
                    this.classList.remove('loading');
                });
            });

            // Script bölümüne eklenecek yeni kodlar:
            let drawControl;
            let currentDrawing = null;

            // Drawing controls
            const drawOptions = {
                draw: {
                    marker: false, // Marker çizimini devre dışı bırak (zaten var)
                    circle: false,
                    circlemarker: false,
                    rectangle: false,
                    polyline: {
                        shapeOptions: {
                            color: '#3388ff',
                            weight: 4
                        }
                    },
                    polygon: {
                        allowIntersection: false,
                        shapeOptions: {
                            color: '#3388ff',
                            fillColor: '#3388ff',
                            fillOpacity: 0.2,
                            weight: 2
                        }
                    }
                },
                edit: false
            };

            // Çizim kontrollerini haritaya ekle
            drawControl = new L.Control.Draw(drawOptions);
            map.addControl(drawControl);

            // Çizim tamamlandığında
            map.on('draw:created', function(e) {
                currentDrawing = e.layer;
                const type = e.layerType;
                const coordinates = type === 'polyline' ? 
                    e.layer.getLatLngs() : 
                    e.layer.getLatLngs()[0];

                // Çizimi haritaya ekle
                map.addLayer(currentDrawing);

                // Çizim formunu göster
                document.getElementById('drawing-form').style.display = 'block';
                document.getElementById('drawing-type').value = type;
            });

            // Çizim kaydetme formu
            document.getElementById('save-drawing-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const type = document.getElementById('drawing-type').value;
                const name = document.getElementById('drawing-name').value;
                const color = document.getElementById('drawing-color').value;

                if (!currentDrawing) {
                    showToast('No drawing to save', 'error');
                    return;
                }

                const coordinates = type === 'polyline' ? 
                    currentDrawing.getLatLngs() : 
                    currentDrawing.getLatLngs()[0];

                const style = {
                    color: color,
                    weight: type === 'polyline' ? 4 : 2,
                    fillColor: color,
                    fillOpacity: type === 'polygon' ? 0.2 : 0
                };

                try {
                    const response = await fetch(`http://localhost:3000/api/${type === 'polyline' ? 'lines' : 'polygons'}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            name: name,
                            coordinates: coordinates,
                            style: style
                        })
                    });

                    if (!response.ok) throw new Error('Failed to save drawing');

                    showToast(`${type} saved successfully`, 'success');
                    document.getElementById('drawing-form').style.display = 'none';
                    loadDrawings();
                } catch (error) {
                    console.error('Error saving drawing:', error);
                    showToast('Error saving drawing', 'error');
                }
            });

            // Çizimleri yükleme fonksiyonu
            async function loadDrawings() {
                await Promise.all([loadLines(), loadPolygons()]);
            }

            // Çizim silme fonksiyonu
            async function deleteDrawing(type, id) {
                if (!confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)) return;

                try {
                    const response = await fetch(`http://localhost:3000/api/${type}/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) throw new Error(`Failed to delete ${type.slice(0, -1)}`);

                    showToast(`${type.slice(0, -1)} deleted successfully`, 'success');
                    loadDrawings(); // Çizimleri yeniden yükle
                } catch (error) {
                    console.error('Error deleting drawing:', error);
                    showToast('Error deleting drawing', 'error');
                }
            }

            // Çizim iptal fonksiyonu
            function cancelDrawing() {
                if (currentDrawing) {
                    map.removeLayer(currentDrawing);
                    currentDrawing = null;
                }
                document.getElementById('drawing-form').style.display = 'none';
                document.getElementById('save-drawing-form').reset();
            }

            // Load points butonuna çizimleri de yükleme özelliği ekle
            const originalLoadPointsBtnClick = document.getElementById('load-points-btn').onclick;
            document.getElementById('load-points-btn').onclick = function() {
                originalLoadPointsBtnClick.call(this);
                loadDrawings();
            };

            // Draw line butonu için olay dinleyici
            document.getElementById('draw-line').addEventListener('click', function() {
                new L.Draw.Polyline(map, drawOptions.draw.polyline).enable();
                this.classList.add('active');
            });

            // Draw polygon butonu için olay dinleyici
            document.getElementById('draw-polygon').addEventListener('click', function() {
                new L.Draw.Polygon(map, drawOptions.draw.polygon).enable();
                this.classList.add('active');
            });

            // Çizim başladığında butonları güncelle
            map.on('draw:drawstart', function() {
                document.getElementById('cancel-drawing').style.display = 'block';
            });

            // Çizim bittiğinde butonları güncelle
            map.on('draw:drawstop', function() {
                document.getElementById('draw-line').classList.remove('active');
                document.getElementById('draw-polygon').classList.remove('active');
                document.getElementById('cancel-drawing').style.display = 'none';
            });

            // Kapatma fonksiyonu
            function closeUpdateForm() {
                document.getElementById('update-form-container').style.display = 'none';
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                    selectedMarker = null;
                }
            }

            // Separate load functions for lines and polygons
            async function loadLines() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('http://localhost:3000/api/lines', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const lines = await response.json();

                    // Clear existing lines
                    map.eachLayer((layer) => {
                        if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                            map.removeLayer(layer);
                        }
                    });

                    // Draw lines
                    lines.forEach(line => {
                        const coords = JSON.parse(line.coordinates);
                        const style = JSON.parse(line.style);
                        const polyline = L.polyline(coords, style).addTo(map);
                        
                        polyline.bindPopup(`
                            <div class="drawing-popup">
                                <h4>${line.name}</h4>
                                <button onclick="deleteDrawing('lines', ${line.id})" class="btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `);
                    });
                    showToast('Lines loaded successfully', 'success');
                } catch (error) {
                    console.error('Error loading lines:', error);
                    showToast('Error loading lines', 'error');
                }
            }

            async function loadPolygons() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('http://localhost:3000/api/polygons', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const polygons = await response.json();

                    // Clear existing polygons
                    map.eachLayer((layer) => {
                        if (layer instanceof L.Polygon) {
                            map.removeLayer(layer);
                        }
                    });

                    // Draw polygons
                    polygons.forEach(polygon => {
                        const coords = JSON.parse(polygon.coordinates);
                        const style = JSON.parse(polygon.style);
                        const poly = L.polygon(coords, style).addTo(map);
                document.getElementById('update-form-container').style.display = 'none';
                        
                        poly.bindPopup(`
                            <div class="drawing-popup">
                                <h4>${polygon.name}</h4>
                                <button onclick="deleteDrawing('polygons', ${polygon.id})" class="btn-danger">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `);
                    });
                    showToast('Polygons loaded successfully', 'success');
                } catch (error) {
                    console.error('Error loading polygons:', error);
                    showToast('Error loading polygons', 'error');
                }
            }

            // Add event listeners for the new buttons
            document.getElementById('load-lines-btn').addEventListener('click', function() {
                this.classList.add('loading');
                loadLines().finally(() => {
                    this.classList.remove('loading');
                });
            });

            document.getElementById('load-polygons-btn').addEventListener('click', function() {
                this.classList.add('loading');
                loadPolygons().finally(() => {
                    this.classList.remove('loading');
                });
            });

            // Update the existing loadDrawings function to use the new separate functions
            async function loadDrawings() {
                await Promise.all([loadLines(), loadPolygons()]);
            }
        </script>
    </body>
</html>
                if (selectedMarker) {
                    map.removeLayer(selectedMarker);
                    selectedMarker = null;
                }
            }
        </script>
    </body>
</html>